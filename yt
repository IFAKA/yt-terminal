#!/bin/bash
# YouTube terminal browser with detailed progress and thumbnails

set -o pipefail

VERSION="1.0.0"

# Default configuration
DEFAULT_NUM_RESULTS=10
DEFAULT_MAX_QUALITY=1080
DEFAULT_TIMEOUT=90
DEFAULT_VOLUME=100
DEFAULT_CACHE_DIR="$HOME/.cache/yt-thumbnails"
DEFAULT_SEARCH_CACHE_DIR="$HOME/.cache/yt-search"
DEFAULT_PLAYLIST_CACHE_DIR="$HOME/.cache/yt-playlists"
DEFAULT_CACHE_EXPIRY=3600  # 1 hour in seconds
CONFIG_DIR="$HOME/.config/yt"
CONFIG_FILE="$CONFIG_DIR/config"

# Load configuration
load_config() {
    # Set defaults
    NUM_RESULTS=${NUM_RESULTS:-$DEFAULT_NUM_RESULTS}
    MAX_QUALITY=${MAX_QUALITY:-$DEFAULT_MAX_QUALITY}
    TIMEOUT=${TIMEOUT:-$DEFAULT_TIMEOUT}
    VOLUME=${VOLUME:-$DEFAULT_VOLUME}
    CACHE_DIR=${CACHE_DIR:-$DEFAULT_CACHE_DIR}
    SEARCH_CACHE_DIR=${SEARCH_CACHE_DIR:-$DEFAULT_SEARCH_CACHE_DIR}
    PLAYLIST_CACHE_DIR=${PLAYLIST_CACHE_DIR:-$DEFAULT_PLAYLIST_CACHE_DIR}
    CACHE_EXPIRY=${CACHE_EXPIRY:-$DEFAULT_CACHE_EXPIRY}
    
    # Create cache directories
    mkdir -p "$CACHE_DIR" "$SEARCH_CACHE_DIR" "$PLAYLIST_CACHE_DIR" 2>/dev/null
    
    # Load user config if it exists
    if [ -f "$CONFIG_FILE" ]; then
        # shellcheck source=/dev/null
        source "$CONFIG_FILE"
    fi
}

# Generate cache key from search term
get_cache_key() {
    local search_term="$1"
    local search_type="$2"  # "video" or "playlist"
    echo "${search_type}_$(echo -n "$search_term" | md5)"
}

# Check if cache is valid (not expired)
is_cache_valid() {
    local cache_file="$1"
    
    if [ ! -f "$cache_file" ]; then
        return 1
    fi
    
    local current_time=$(date +%s)
    local file_time=$(stat -f %m "$cache_file" 2>/dev/null || stat -c %Y "$cache_file" 2>/dev/null)
    local age=$((current_time - file_time))
    
    if [ "$age" -lt "$CACHE_EXPIRY" ]; then
        return 0
    else
        return 1
    fi
}

# Cleanup function for temp files
cleanup() {
    local exit_code=$?
    if [ -n "$tmpfile" ] && [ -f "$tmpfile" ]; then
        rm -f "$tmpfile"
    fi
    exit "$exit_code"
}

trap cleanup EXIT INT TERM

# Check dependencies
check_dependencies() {
    local missing_deps=()
    local optional_deps=()
    
    # Required dependencies
    command -v yt-dlp &> /dev/null || missing_deps+=("yt-dlp")
    command -v mpv &> /dev/null || missing_deps+=("mpv")
    command -v fzf &> /dev/null || missing_deps+=("fzf")
    command -v jq &> /dev/null || missing_deps+=("jq")
    command -v curl &> /dev/null || missing_deps+=("curl")
    
    # Optional dependencies
    command -v chafa &> /dev/null || optional_deps+=("chafa")
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Missing required dependencies"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Please install the following:"
        for dep in "${missing_deps[@]}"; do
            echo "  â€¢ $dep"
        done
        echo ""
        echo "Installation command (macOS):"
        echo "  brew install ${missing_deps[*]}"
        echo ""
        echo "Installation command (Linux/Debian):"
        echo "  sudo apt install ${missing_deps[*]}"
        echo ""
        return 1
    fi
    
    if [ ${#optional_deps[@]} -ne 0 ]; then
        echo "â„¹ï¸  Optional: Install 'chafa' for thumbnail previews"
        echo "   brew install chafa"
        echo ""
    fi
    
    return 0
}

# Show usage information
show_usage() {
    echo "Usage: yt [OPTIONS] <search term>"
    echo ""
    echo "Options:"
    echo "  -f, --first        Auto-play first search result"
    echo "  -a, --audio-only   Play audio only (no video)"
    echo "  -p, --playlist     Search for playlists instead of videos"
    echo "  --clear-cache      Clear search and playlist cache"
    echo ""
    echo "Examples:"
    echo "  yt vim tutorial              # Search and select interactively"
    echo "  yt -f lofi hip hop           # Auto-play first result"
    echo "  yt -a music                  # Search and play audio only"
    echo "  yt -p lofi playlists         # Browse playlists"
    echo "  yt -a -p chill music         # Browse playlists, play audio only"
    echo "  yt <url>                     # Play video from URL"
    echo ""
    echo "Cache:"
    echo "  Search results are cached for $((CACHE_EXPIRY / 60)) minutes"
    echo "  Cache location: $SEARCH_CACHE_DIR"
    echo ""
    echo "Version: $VERSION"
    echo "Configuration file: $CONFIG_FILE"
}

# Clear cache
clear_cache() {
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ—‘ï¸  Clearing cache..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    local deleted=0
    
    if [ -d "$SEARCH_CACHE_DIR" ]; then
        local count=$(find "$SEARCH_CACHE_DIR" -type f | wc -l | xargs)
        rm -rf "$SEARCH_CACHE_DIR"/*
        deleted=$((deleted + count))
        echo "âœ“ Cleared search cache ($count files)"
    fi
    
    if [ -d "$PLAYLIST_CACHE_DIR" ]; then
        local count=$(find "$PLAYLIST_CACHE_DIR" -type f | wc -l | xargs)
        rm -rf "$PLAYLIST_CACHE_DIR"/*
        deleted=$((deleted + count))
        echo "âœ“ Cleared playlist cache ($count files)"
    fi
    
    if [ -d "$CACHE_DIR" ]; then
        local count=$(find "$CACHE_DIR" -name "*.jpg" | wc -l | xargs)
        rm -rf "$CACHE_DIR"/*.jpg
        deleted=$((deleted + count))
        echo "âœ“ Cleared thumbnail cache ($count files)"
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Cleared $deleted cached items"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

# Play video from URL
play_url() {
    local url="$1"
    local audio_only="$2"
    local format
    
    if [ "$audio_only" = "true" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸµ Playing audio from URL..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        format="bestaudio/best"
    else
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â–¶ Playing video from URL..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        format="bestvideo[height<=${MAX_QUALITY}]+bestaudio/best"
    fi
    echo ""
    
    if ! mpv "$url" \
        --ytdl-format="$format" \
        --volume="$VOLUME" \
        --audio-device=auto; then
        echo "âŒ Error playing video"
        return 1
    fi
    
    return 0
}

# Search YouTube for playlists
search_playlists_youtube() {
    local search_term="$1"
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“š Searching YouTube playlists for: $search_term"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Create temp file
    tmpfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # Check cache first
    local cache_key
    cache_key=$(get_cache_key "$search_term" "playlist")
    local cache_file="$SEARCH_CACHE_DIR/$cache_key.json"
    
    if is_cache_valid "$cache_file"; then
        echo "ğŸ“¦ Loading from cache..."
        cp "$cache_file" "$tmpfile"
        
        # Display cached results
        local count=0
        while IFS=$'\t' read -r title _ id _; do
            count=$((count + 1))
            echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$title" | cut -c1-60)..."
        done < "$tmpfile"
        echo ""
        return 0
    fi
    
    echo "â³ Fetching playlists..."
    
    # URL-encode the search term
    local encoded_term
    encoded_term=$(echo "$search_term" | sed 's/ /+/g')
    
    # Create temp file for raw JSON
    local jsonfile
    jsonfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # Use YouTube search URL with playlist filter (sp=EgIQAw%253D%253D)
    # This filter specifically searches for playlists
    if ! timeout "$TIMEOUT" yt-dlp "https://www.youtube.com/results?search_query=${encoded_term}&sp=EgIQAw%253D%253D" \
        --flat-playlist \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        --playlist-end "$NUM_RESULTS" \
        2>/dev/null > "$jsonfile"; then
        rm -f "$jsonfile"
        echo "âŒ Search failed or timed out"
        return 1
    fi
    
    # Parse and display results
    local count=0
    while IFS= read -r line && [ "$count" -lt "$NUM_RESULTS" ]; do
        # Extract playlist info
        local playlist_title playlist_id thumbnail
        playlist_title=$(echo "$line" | jq -r '.title // "Unknown"')
        playlist_id=$(echo "$line" | jq -r '.id // ""')
        thumbnail=$(echo "$line" | jq -r '.thumbnails[0].url // ""')
        
        if [ -n "$playlist_id" ] && [ "$playlist_id" != "null" ]; then
            # Store: title, "PL" (placeholder for count), id, thumbnail
            echo "$playlist_title"$'\t'"PL"$'\t'"$playlist_id"$'\t'"$thumbnail" >> "$tmpfile"
            
            count=$((count + 1))
            echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$playlist_title" | cut -c1-60)..."
        fi
    done < "$jsonfile"
    
    rm -f "$jsonfile"
    echo ""
    
    # Check if we got any results
    if [ ! -s "$tmpfile" ] || [ "$count" -eq 0 ]; then
        echo "âŒ No playlists found!"
        return 1
    fi
    
    # Cache the results
    cp "$tmpfile" "$cache_file"
    
    return 0
}

# Search YouTube for videos
search_youtube() {
    local search_term="$1"
    local search_playlists="$2"
    
    # Use different search for playlists
    if [ "$search_playlists" = "true" ]; then
        search_playlists_youtube "$search_term"
        return $?
    fi
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ” Searching YouTube for: $search_term"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Create temp file
    tmpfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # Check cache first
    local cache_key
    cache_key=$(get_cache_key "$search_term" "video")
    local cache_file="$SEARCH_CACHE_DIR/$cache_key.json"
    
    if is_cache_valid "$cache_file"; then
        echo "ğŸ“¦ Loading from cache..."
        cp "$cache_file" "$tmpfile"
        
        # Display cached results
        local count=0
        while IFS=$'\t' read -r title _ _ _; do
            count=$((count + 1))
            echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$title" | cut -c1-60)..."
        done < "$tmpfile"
        echo ""
        return 0
    fi
    
    echo "â³ Fetching videos..."
    
    # Create temp file for raw JSON
    local jsonfile
    jsonfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # Fetch videos to temp file
    if ! timeout "$TIMEOUT" yt-dlp "ytsearch${NUM_RESULTS}:$search_term" \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        2>/dev/null > "$jsonfile"; then
        rm -f "$jsonfile"
        echo "âŒ Search failed or timed out"
        return 1
    fi
    
    # Parse and display results
    local count=0
    while IFS= read -r line && [ "$count" -lt "$NUM_RESULTS" ]; do
        # Parse video data
        video_data=$(echo "$line" | jq -r '"\(.title)\t\(.duration_string // "LIVE")\t\(.id)\t\(.thumbnail)"')
        echo "$video_data" >> "$tmpfile"
        
        count=$((count + 1))
        echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$line" | jq -r '.title' | cut -c1-60)..."
    done < "$jsonfile"
    
    rm -f "$jsonfile"
    echo ""
    
    # Check if we got any results
    if [ ! -s "$tmpfile" ] || [ "$count" -eq 0 ]; then
        echo "âŒ No results found!"
        return 1
    fi
    
    # Cache the results
    cp "$tmpfile" "$cache_file"
    
    return 0
}

# Download thumbnails
download_thumbnails() {
    local search_playlists="$1"
    mkdir -p "$CACHE_DIR" || { echo "âŒ Failed to create cache directory"; return 1; }
    
    while IFS=$'\t' read -r title duration id thumbnail; do
        if [ "$search_playlists" = "true" ]; then
            # Format playlist result line
            results="${results}$(printf "%-85s %s" "$title" "$id")"$'\n'
        else
            # Format video result line
            results="${results}$(printf "%-80s [%8s] %s" "$title" "$duration" "$id")"$'\n'
        fi
        
        # Download thumbnail in background for preview
        if [ -n "$thumbnail" ]; then
            curl -s "$thumbnail" -o "$CACHE_DIR/$id.jpg" 2>/dev/null &
        fi
    done < "$tmpfile"
    
    if [ -z "$results" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ No results found!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        return 1
    fi
    
    # Count actual non-empty lines
    items_count=$(echo "$results" | grep -c '^.')
    if [ "$search_playlists" = "true" ]; then
        echo "âœ… Successfully fetched $items_count playlists!"
    else
        echo "âœ… Successfully fetched $items_count videos!"
    fi
    echo "ğŸ“¥ Downloading thumbnails..."
    echo ""
    
    # Wait a bit for thumbnails to download
    sleep 2
    echo "âœ… Ready!"
    sleep 1
    
    return 0
}

# Preview playlist contents (for fzf preview)
preview_playlist() {
    local playlist_id="$1"
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“š Playlist Contents"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Check cache first
    local cache_file="$PLAYLIST_CACHE_DIR/$playlist_id.json"
    
    if is_cache_valid "$cache_file"; then
        echo "ğŸ“¦ Cached playlist"
        echo ""
        
        # Read from cache
        local videos
        videos=$(cat "$cache_file")
        
        # Display first 20 videos
        local count=0
        while IFS= read -r line; do
            local video_title
            video_title=$(echo "$line" | jq -r '.title // "Unknown"')
            count=$((count + 1))
            printf "%2d. %s\n" "$count" "$video_title"
            [ "$count" -ge 20 ] && break
        done <<< "$videos"
        
        # Get total count
        local total_count
        total_count=$(echo "$videos" | wc -l | xargs)
        
        if [ "$total_count" -gt 20 ]; then
            echo ""
            echo "... and $((total_count - 20)) more videos"
        fi
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Total: $total_count videos in playlist"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        return 0
    fi
    
    echo "â³ Loading videos..."
    echo ""
    
    # Fetch first 20 videos from playlist
    local videos
    videos=$(timeout 10 yt-dlp "https://youtube.com/playlist?list=$playlist_id" \
        --flat-playlist \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        --playlist-end 20 \
        2>/dev/null)
    
    if [ -z "$videos" ]; then
        echo "âŒ Could not load playlist contents"
        return 1
    fi
    
    # Display first 20 videos
    local count=0
    while IFS= read -r line; do
        local video_title
        video_title=$(echo "$line" | jq -r '.title // "Unknown"')
        count=$((count + 1))
        printf "%2d. %s\n" "$count" "$video_title"
    done <<< "$videos"
    
    # Get total count
    local total_count
    total_count=$(echo "$videos" | wc -l | xargs)
    
    # Check if there are more videos (but don't wait too long)
    local full_count
    full_count=$(timeout 5 yt-dlp "https://youtube.com/playlist?list=$playlist_id" \
        --flat-playlist \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        2>/dev/null | wc -l | xargs)
    
    if [ -n "$full_count" ] && [ "$full_count" -gt 20 ]; then
        echo ""
        echo "... and $((full_count - 20)) more videos"
        total_count=$full_count
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Total: $total_count videos in playlist"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Cache the full result
    echo "$videos" > "$cache_file"
}

# Play entire playlist
play_playlist() {
    local playlist_id="$1"
    local playlist_title="$2"
    local audio_only="$3"
    local format
    local url
    
    url="https://youtube.com/playlist?list=$playlist_id"
    
    # Set format based on audio-only flag
    if [ "$audio_only" = "true" ]; then
        format="bestaudio/best"
    else
        format="bestvideo[height<=${MAX_QUALITY}]+bestaudio/best"
    fi
    
    clear
    if [ "$audio_only" = "true" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸµ PLAYING PLAYLIST (AUDIO ONLY)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    else
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“š PLAYING PLAYLIST"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    fi
    echo ""
    echo "Playlist: $playlist_title"
    echo "URL:      $url"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "MPV Settings:"
    echo "  - Format: $format"
    echo "  - Volume: $VOLUME"
    echo "  - Audio Device: auto"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Starting playlist playback in 2 seconds..."
    sleep 2
    
    # Play playlist with mpv
    if ! mpv "$url" \
        --ytdl-format="$format" \
        --volume="$VOLUME" \
        --audio-device=auto; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Playback failed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        return 1
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Playlist finished"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    return 0
}

# Select video with fzf or return first result
select_video() {
    local search_term="$1"
    local auto_first="$2"
    local search_playlists="$3"
    local videos_count
    local selected
    
    # Count actual non-empty lines
    videos_count=$(echo "$results" | grep -c '^.')
    
    # If auto-first flag is set, return first result
    if [ "$auto_first" = "true" ]; then
        selected=$(echo "$results" | head -n 1)
        if [ -z "$selected" ]; then
            echo "âŒ No results found" >&2
            return 1
        fi
        echo "ğŸ¯ Auto-playing first result..." >&2
        echo "" >&2
        echo "$selected"
        return 0
    fi
    
    # Clear screen and show results (redirect to stderr to avoid capture)
    clear >&2
    if [ "$search_playlists" = "true" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
        echo "ğŸ“š YouTube Playlists: $search_term ($videos_count results)" >&2
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    else
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
        echo "ğŸ¥ YouTube Search: $search_term ($videos_count results)" >&2
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    fi
    echo "" >&2
    
    # Different preview based on search mode
    if [ "$search_playlists" = "true" ]; then
        # For playlist mode, show playlist contents
        selected=$(echo "$results" | fzf \
            --height=90% \
            --layout=reverse \
            --border \
            --prompt="ğŸ“š " \
            --header="[j/k] navigate | [Ctrl-d/u] page | [Enter] play playlist | [q] quit" \
            --preview="$0 --preview-playlist \$(echo {} | awk '{print \$NF}')" \
            --preview-window=right:60%:wrap \
            --color='fg:#ffffff,bg:#000000,hl:#ff0000,fg+:#ffffff,bg+:#333333,hl+:#ff0000' \
            --pointer='â–¶' \
            --marker='âœ“' \
            --bind 'j:down,k:up' \
            --bind 'ctrl-d:half-page-down,ctrl-u:half-page-up' \
            --bind 'ctrl-f:page-down,ctrl-b:page-up' \
            --bind 'q:abort')
    else
        # For videos, show thumbnail
        selected=$(echo "$results" | fzf \
            --height=90% \
            --layout=reverse \
            --border \
            --prompt="â–¶ " \
            --header="[j/k] navigate | [Ctrl-d/u] page | [Enter] play | [q] quit" \
            --preview="video_id=\$(echo {} | awk '{print \$NF}'); if [ -f \"$CACHE_DIR/\$video_id.jpg\" ]; then chafa --format=kitty --size=60x30 \"$CACHE_DIR/\$video_id.jpg\" 2>/dev/null; else echo 'â³ Downloading thumbnail...'; fi" \
            --preview-window=right:40%:wrap \
            --color='fg:#ffffff,bg:#000000,hl:#ff0000,fg+:#ffffff,bg+:#333333,hl+:#ff0000' \
            --pointer='â–¶' \
            --marker='âœ“' \
            --bind 'j:down,k:up' \
            --bind 'ctrl-d:half-page-down,ctrl-u:half-page-up' \
            --bind 'ctrl-f:page-down,ctrl-b:page-up' \
            --bind 'q:abort')
    fi
    
    if [ -z "$selected" ]; then
        echo "" >&2
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
        echo "âŒ Cancelled" >&2
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
        return 1
    fi
    
    echo "$selected"
    return 0
}

# Play selected video
play_video() {
    local selected="$1"
    local audio_only="$2"
    local video_id title url format
    
    video_id=$(echo "$selected" | awk '{print $NF}')
    title=$(echo "$selected" | sed 's/\[.*\].*$//' | xargs)
    url="https://youtube.com/watch?v=$video_id"
    
    # Set format based on audio-only flag
    if [ "$audio_only" = "true" ]; then
        format="bestaudio/best"
    else
        format="bestvideo[height<=${MAX_QUALITY}]+bestaudio/best"
    fi
    
    # Show thumbnail before playing
    clear
    if command -v chafa &> /dev/null && [ -f "$CACHE_DIR/$video_id.jpg" ]; then
        if [ "$audio_only" = "true" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸµ AUDIO PREVIEW"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        else
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â–¶ VIDEO PREVIEW"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        fi
        echo ""
        chafa --format=kitty --size=60x30 "$CACHE_DIR/$video_id.jpg" 2>/dev/null
        echo ""
    fi
    
    if [ "$audio_only" = "true" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸµ PLAYING AUDIO"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    else
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â–¶ PLAYING"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    fi
    echo ""
    echo "Title:    $title"
    echo "Video ID: $video_id"
    echo "URL:      $url"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "MPV Settings:"
    echo "  - Format: $format"
    echo "  - Volume: $VOLUME"
    echo "  - Audio Device: auto"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Starting playback in 2 seconds..."
    sleep 2
    
    # Play with explicit settings
    if ! mpv "$url" \
        --ytdl-format="$format" \
        --volume="$VOLUME" \
        --audio-device=auto; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Playback failed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        return 1
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Playback finished"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    return 0
}

# Main function
main() {
    # Load configuration
    load_config
    
    # Handle internal preview mode (called by fzf)
    if [ "$1" = "--preview-playlist" ]; then
        preview_playlist "$2"
        exit 0
    fi
    
    # Parse flags
    local auto_first=false
    local audio_only=false
    local search_playlists=false
    local search_term=""
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--first)
                auto_first=true
                shift
                ;;
            -a|--audio-only)
                audio_only=true
                shift
                ;;
            -p|--playlist)
                search_playlists=true
                shift
                ;;
            --clear-cache)
                clear_cache
                exit 0
                ;;
            -h|--help)
                show_usage
                exit 0
                ;;
            -*)
                echo "Unknown option: $1"
                show_usage
                exit 1
                ;;
            *)
                search_term="$search_term $1"
                shift
                ;;
        esac
    done
    
    # Trim leading/trailing whitespace
    search_term=$(echo "$search_term" | xargs)
    
    # Check dependencies (always run before usage to give helpful error messages)
    if ! check_dependencies; then
        exit 1
    fi
    
    if [ -z "$search_term" ]; then
        show_usage
        exit 1
    fi
    
    # Check if input is a URL
    if [[ "$search_term" =~ ^https?:// ]]; then
        if ! play_url "$search_term" "$audio_only"; then
            exit 1
        fi
        exit 0
    fi
    
    # Search YouTube
    if ! search_youtube "$search_term" "$search_playlists"; then
        exit 1
    fi
    
    # Download thumbnails and format results
    if ! download_thumbnails "$search_playlists"; then
        exit 1
    fi
    
    # Select video or playlist
    local selected
    if ! selected=$(select_video "$search_term" "$auto_first" "$search_playlists"); then
        exit 0
    fi
    
    # If playlist mode, play the selected playlist
    if [ "$search_playlists" = "true" ]; then
        local playlist_id playlist_title
        playlist_id=$(echo "$selected" | awk '{print $NF}')
        playlist_title=$(echo "$selected" | awk -F'\t' '{print $1}' | sed 's/^[[:space:]]*//' | xargs)
        
        if ! play_playlist "$playlist_id" "$playlist_title" "$audio_only"; then
            exit 1
        fi
    else
        # Play single video
        if ! play_video "$selected" "$audio_only"; then
            exit 1
        fi
    fi
    
    exit 0
}

# Run main function
main "$@"
