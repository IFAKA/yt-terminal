#!/bin/bash
# YouTube terminal browser with detailed progress and thumbnails

set -o pipefail

VERSION="1.0.0"

# Default configuration
DEFAULT_NUM_RESULTS=10
DEFAULT_MAX_QUALITY=1080
DEFAULT_TIMEOUT=90
DEFAULT_VOLUME=100
DEFAULT_CACHE_DIR="$HOME/.cache/yt-thumbnails"
CONFIG_DIR="$HOME/.config/yt"
CONFIG_FILE="$CONFIG_DIR/config"

# Load configuration
load_config() {
    # Set defaults
    NUM_RESULTS=${NUM_RESULTS:-$DEFAULT_NUM_RESULTS}
    MAX_QUALITY=${MAX_QUALITY:-$DEFAULT_MAX_QUALITY}
    TIMEOUT=${TIMEOUT:-$DEFAULT_TIMEOUT}
    VOLUME=${VOLUME:-$DEFAULT_VOLUME}
    CACHE_DIR=${CACHE_DIR:-$DEFAULT_CACHE_DIR}
    
    # Load user config if it exists
    if [ -f "$CONFIG_FILE" ]; then
        # shellcheck source=/dev/null
        source "$CONFIG_FILE"
    fi
}

# Cleanup function for temp files
cleanup() {
    local exit_code=$?
    if [ -n "$tmpfile" ] && [ -f "$tmpfile" ]; then
        rm -f "$tmpfile"
    fi
    if [ -n "$progressfile" ] && [ -f "$progressfile" ]; then
        rm -f "$progressfile"
    fi
    if [ -n "$statusfile" ] && [ -f "$statusfile" ]; then
        rm -f "$statusfile"
    fi
    exit "$exit_code"
}

trap cleanup EXIT INT TERM

# Check dependencies
check_dependencies() {
    local missing_deps=()
    local optional_deps=()
    
    # Required dependencies
    command -v yt-dlp &> /dev/null || missing_deps+=("yt-dlp")
    command -v mpv &> /dev/null || missing_deps+=("mpv")
    command -v fzf &> /dev/null || missing_deps+=("fzf")
    command -v jq &> /dev/null || missing_deps+=("jq")
    command -v curl &> /dev/null || missing_deps+=("curl")
    
    # Optional dependencies
    command -v chafa &> /dev/null || optional_deps+=("chafa")
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Missing required dependencies"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Please install the following:"
        for dep in "${missing_deps[@]}"; do
            echo "  â€¢ $dep"
        done
        echo ""
        echo "Installation command (macOS):"
        echo "  brew install ${missing_deps[*]}"
        echo ""
        echo "Installation command (Linux/Debian):"
        echo "  sudo apt install ${missing_deps[*]}"
        echo ""
        return 1
    fi
    
    if [ ${#optional_deps[@]} -ne 0 ]; then
        echo "â„¹ï¸  Optional: Install 'chafa' for thumbnail previews"
        echo "   brew install chafa"
        echo ""
    fi
    
    return 0
}

# Show usage information
show_usage() {
    echo "Usage: yt <search term>"
    echo "Example: yt vim tutorial"
    echo ""
    echo "Or play from URL:"
    echo "  yt <url>"
    echo ""
    echo "Version: $VERSION"
    echo ""
    echo "Configuration file: $CONFIG_FILE"
}

# Play video from URL
play_url() {
    local url="$1"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "â–¶ Playing video from URL..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    if ! mpv "$url" \
        --ytdl-format="bestvideo[height<=${MAX_QUALITY}]+bestaudio/best" \
        --volume="$VOLUME" \
        --audio-device=auto; then
        echo "âŒ Error playing video"
        return 1
    fi
    
    return 0
}

# Search YouTube
search_youtube() {
    local search_term="$1"
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ” Searching YouTube for: $search_term"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Create temp files
    tmpfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    progressfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    statusfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # Run search in background with verbose output
    (
        echo "Initializing yt-dlp..." > "$statusfile"
        sleep 1
        
        echo "Querying YouTube search API..." > "$statusfile"
        sleep 1
        
        echo "Parsing video metadata..." > "$statusfile"
        
        if ! yt-dlp "ytsearch${NUM_RESULTS}:$search_term" \
            --dump-json \
            --skip-download \
            --no-warnings \
            --quiet \
            2>/dev/null | head -n "$NUM_RESULTS" | while read -r line; do
                # Parse each video as it comes - use TAB as delimiter
                video_data=$(echo "$line" | jq -r '"\(.title)\t\(.duration_string // "LIVE")\t\(.id)\t\(.thumbnail)"')
                echo "$video_data" >> "$tmpfile"
                
                # Update status
                count=$(wc -l < "$tmpfile")
                echo "Processing video $count/$NUM_RESULTS..." > "$statusfile"
            done; then
            echo "error" > "$progressfile"
            exit 1
        fi
        
        echo "Finalizing results..." > "$statusfile"
        sleep 0.5
        echo "done" > "$progressfile"
    ) &
    
    local search_pid=$!
    
    # Show detailed progress
    show_search_progress "$search_pid"
    local progress_result=$?
    
    if [ $progress_result -ne 0 ]; then
        return 1
    fi
    
    # Wait for background process to finish
    if ! wait "$search_pid"; then
        echo ""
        echo "âŒ Search failed"
        return 1
    fi
    
    # Check for error state
    if [ -f "$progressfile" ] && [ "$(cat "$progressfile")" = "error" ]; then
        echo ""
        echo "âŒ Error during search"
        return 1
    fi
    
    return 0
}

# Show search progress with spinner
show_search_progress() {
    local search_pid=$1
    local spinner="â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â "
    local count=0
    local last_video_count=0
    local timeout_count=$((TIMEOUT * 10))
    
    while [ ! -f "$progressfile" ] || [ "$(cat "$progressfile")" != "done" ]; do
        # Check if search process is still running
        if ! kill -0 "$search_pid" 2>/dev/null; then
            if [ ! -f "$progressfile" ] || [ "$(cat "$progressfile")" != "done" ]; then
                return 1
            fi
            break
        fi
        
        videos_found=$(wc -l < "$tmpfile" 2>/dev/null || echo 0)
        status_msg=$(cat "$statusfile" 2>/dev/null || echo "Waiting...")
        
        # Get current spinner character
        local i=$(( count % 10 ))
        local spin_char="${spinner:$i:1}"
        
        # Show detailed progress
        printf "\r%s %s | Videos: %d/%d" "$spin_char" "$status_msg" "$videos_found" "$NUM_RESULTS"
        
        # Show when a new video is found
        if [ "$videos_found" -gt "$last_video_count" ] && [ "$videos_found" -gt 0 ]; then
            # Get the last video title (use tab delimiter)
            local last_video
            last_video=$(tail -1 "$tmpfile" 2>/dev/null | cut -f1)
            printf "\n  âœ“ Found: %s\n" "${last_video:0:70}"
            printf "%s %s | Videos: %d/%d" "$spin_char" "$status_msg" "$videos_found" "$NUM_RESULTS"
        fi
        last_video_count=$videos_found
        
        count=$((count + 1))
        sleep 0.1
        
        # Timeout check
        if [ $count -gt "$timeout_count" ]; then
            kill "$search_pid" 2>/dev/null
            echo ""
            echo ""
            echo "âŒ Timeout - YouTube is taking too long to respond"
            echo "   Try again or use a simpler search term"
            return 1
        fi
    done
    
    rm -f "$progressfile" "$statusfile"
    echo ""
    echo ""
    
    return 0
}

# Download thumbnails
download_thumbnails() {
    mkdir -p "$CACHE_DIR" || { echo "âŒ Failed to create cache directory"; return 1; }
    
    while IFS=$'\t' read -r title duration id thumbnail; do
        # Format the result line - add newline after each entry
        results="${results}$(printf "%-80s [%8s] %s" "$title" "$duration" "$id")"$'\n'
        
        # Download thumbnail in background for preview
        if [ -n "$thumbnail" ]; then
            curl -s "$thumbnail" -o "$CACHE_DIR/$id.jpg" 2>/dev/null &
        fi
    done < "$tmpfile"
    
    if [ -z "$results" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ No results found!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        return 1
    fi
    
    # Count actual non-empty lines
    videos_count=$(echo "$results" | grep -c '^.')
    echo "âœ… Successfully fetched $videos_count videos!"
    echo "ğŸ“¥ Downloading thumbnails..."
    echo ""
    
    # Wait a bit for thumbnails to download
    sleep 2
    echo "âœ… Ready!"
    sleep 1
    
    return 0
}

# Select video with fzf
select_video() {
    local search_term="$1"
    local videos_count
    # Count actual non-empty lines
    videos_count=$(echo "$results" | grep -c '^.')
    
    # Clear screen and show results
    clear
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ¥ YouTube Search: $search_term ($videos_count results)"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Use fzf with vim keybindings and thumbnail preview
    local selected
    selected=$(echo "$results" | fzf \
        --height=90% \
        --layout=reverse \
        --border \
        --prompt="â–¶ " \
        --header="[j/k] navigate | [Ctrl-d/u] page | [Enter] play | [q] quit" \
        --preview="video_id=\$(echo {} | awk '{print \$NF}'); if [ -f \"$CACHE_DIR/\$video_id.jpg\" ]; then chafa --format=kitty --size=60x30 \"$CACHE_DIR/\$video_id.jpg\" 2>/dev/null; else echo 'â³ Downloading thumbnail...'; fi" \
        --preview-window=right:40%:wrap \
        --color='fg:#ffffff,bg:#000000,hl:#ff0000,fg+:#ffffff,bg+:#333333,hl+:#ff0000' \
        --pointer='â–¶' \
        --marker='âœ“' \
        --bind 'j:down,k:up' \
        --bind 'ctrl-d:half-page-down,ctrl-u:half-page-up' \
        --bind 'ctrl-f:page-down,ctrl-b:page-up' \
        --bind 'q:abort')
    
    if [ -z "$selected" ]; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Cancelled"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        return 1
    fi
    
    echo "$selected"
    return 0
}

# Play selected video
play_video() {
    local selected="$1"
    local video_id title url
    
    video_id=$(echo "$selected" | awk '{print $NF}')
    title=$(echo "$selected" | sed 's/\[.*\].*$//' | xargs)
    url="https://youtube.com/watch?v=$video_id"
    
    # Show thumbnail before playing
    clear
    if command -v chafa &> /dev/null && [ -f "$CACHE_DIR/$video_id.jpg" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â–¶ VIDEO PREVIEW"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        chafa --format=kitty --size=60x30 "$CACHE_DIR/$video_id.jpg" 2>/dev/null
        echo ""
    fi
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "â–¶ PLAYING"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Title:    $title"
    echo "Video ID: $video_id"
    echo "URL:      $url"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "MPV Settings:"
    echo "  - Format: bestvideo[height<=${MAX_QUALITY}]+bestaudio/best"
    echo "  - Volume: $VOLUME"
    echo "  - Audio Device: auto"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Starting playback in 2 seconds..."
    sleep 2
    
    # Play with explicit settings
    if ! mpv "$url" \
        --ytdl-format="bestvideo[height<=${MAX_QUALITY}]+bestaudio/best" \
        --volume="$VOLUME" \
        --audio-device=auto; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Playback failed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        return 1
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Playback finished"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    return 0
}

# Main function
main() {
    # Load configuration
    load_config
    
    local search_term="$*"
    
    # Check dependencies (always run before usage to give helpful error messages)
    if ! check_dependencies; then
        exit 1
    fi
    
    if [ -z "$search_term" ]; then
        show_usage
        exit 1
    fi
    
    # Check if input is a URL
    if [[ "$search_term" =~ ^https?:// ]]; then
        if ! play_url "$search_term"; then
            exit 1
        fi
        exit 0
    fi
    
    # Search YouTube
    if ! search_youtube "$search_term"; then
        exit 1
    fi
    
    # Download thumbnails and format results
    if ! download_thumbnails; then
        exit 1
    fi
    
    # Select video
    local selected
    if ! selected=$(select_video "$search_term"); then
        exit 0
    fi
    
    # Play video
    if ! play_video "$selected"; then
        exit 1
    fi
    
    exit 0
}

# Run main function
main "$@"
