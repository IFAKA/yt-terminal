#!/bin/bash
# YouTube terminal browser with detailed progress and thumbnails

set -o pipefail

VERSION="1.0.0"

# Spinner for loading states
show_spinner() {
    local pid=$1
    local message=$2
    local spinstr='â ‹â ™â ¹â ¸â ¼â ´â ¦â §â ‡â '
    local temp
    
    # Check if we have a terminal (for CI/non-interactive environments)
    if [ -t 1 ]; then
        tput civis 2>/dev/null  # Hide cursor
        
        while kill -0 "$pid" 2>/dev/null; do
            temp=${spinstr#?}
            printf "\r%s %s" "${spinstr:0:1}" "$message"
            spinstr=$temp${spinstr%"$temp"}
            sleep 0.1
        done
        
        tput cnorm 2>/dev/null  # Show cursor
        printf "\r"
    else
        # Non-interactive mode: just show the message once
        echo "$message"
        wait "$pid"
    fi
}



# Default configuration
DEFAULT_NUM_RESULTS=10
DEFAULT_MAX_QUALITY=1080
DEFAULT_TIMEOUT=90
DEFAULT_VOLUME=100
DEFAULT_CACHE_DIR="$HOME/.cache/yt-thumbnails"
DEFAULT_SEARCH_CACHE_DIR="$HOME/.cache/yt-search"
DEFAULT_PLAYLIST_CACHE_DIR="$HOME/.cache/yt-playlists"
DEFAULT_CACHE_EXPIRY=3600  # 1 hour in seconds
CONFIG_DIR="$HOME/.config/yt"
CONFIG_FILE="$CONFIG_DIR/config"

# Load configuration
load_config() {
    # Set defaults
    NUM_RESULTS=${NUM_RESULTS:-$DEFAULT_NUM_RESULTS}
    MAX_QUALITY=${MAX_QUALITY:-$DEFAULT_MAX_QUALITY}
    TIMEOUT=${TIMEOUT:-$DEFAULT_TIMEOUT}
    VOLUME=${VOLUME:-$DEFAULT_VOLUME}
    CACHE_DIR=${CACHE_DIR:-$DEFAULT_CACHE_DIR}
    SEARCH_CACHE_DIR=${SEARCH_CACHE_DIR:-$DEFAULT_SEARCH_CACHE_DIR}
    PLAYLIST_CACHE_DIR=${PLAYLIST_CACHE_DIR:-$DEFAULT_PLAYLIST_CACHE_DIR}
    CACHE_EXPIRY=${CACHE_EXPIRY:-$DEFAULT_CACHE_EXPIRY}
    
    # Create cache and config directories
    mkdir -p "$CACHE_DIR" "$SEARCH_CACHE_DIR" "$PLAYLIST_CACHE_DIR" "$CONFIG_DIR" 2>/dev/null
    
    # Load user config if it exists
    if [ -f "$CONFIG_FILE" ]; then
        # shellcheck source=/dev/null
        source "$CONFIG_FILE"
    fi
}

# Detect available browsers for cookie extraction
detect_browsers() {
    local browsers=()
    
    # Check for common browsers (including Brave)
    if command -v brave &> /dev/null || [ -d "$HOME/Library/Application Support/BraveSoftware/Brave-Browser" ] || [ -d "$HOME/.config/BraveSoftware/Brave-Browser" ]; then
        browsers+=("brave")
    fi
    
    if command -v firefox &> /dev/null || [ -d "$HOME/Library/Application Support/Firefox" ] || [ -d "$HOME/.mozilla/firefox" ]; then
        browsers+=("firefox")
    fi
    
    if command -v google-chrome &> /dev/null || [ -d "$HOME/Library/Application Support/Google/Chrome" ] || [ -d "$HOME/.config/google-chrome" ]; then
        browsers+=("chrome")
    fi
    
    if [ -d "$HOME/Library/Application Support/Google/Chrome" ]; then
        browsers+=("chrome")
    fi
    
    if command -v safari &> /dev/null || [ -d "$HOME/Library/Safari" ]; then
        browsers+=("safari")
    fi
    
    if command -v microsoft-edge &> /dev/null || [ -d "$HOME/Library/Application Support/Microsoft Edge" ]; then
        browsers+=("edge")
    fi
    
    echo "${browsers[@]}"
}

# Setup authentication for personal content
setup_authentication() {
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ” Authentication Setup"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "To access personal content (subscriptions, playlists, etc.),"
    echo "we need to use cookies from your browser."
    echo ""
    echo "This is safe and automatic - no passwords needed!"
    echo ""
    
    # Detect available browsers
    local available_browsers
    mapfile -t available_browsers < <(detect_browsers)
    
    if [ ${#available_browsers[@]} -eq 0 ]; then
        echo "âŒ No supported browsers detected."
        echo ""
        echo "Supported browsers: Brave, Firefox, Chrome, Safari, Edge"
        echo ""
        echo "Please make sure you're logged into YouTube in one of these browsers."
        return 1
    fi
    
    echo "Detected browsers:"
    for i in "${!available_browsers[@]}"; do
        echo "  $((i+1)). ${available_browsers[$i]}"
    done
    echo ""
    
    # Auto-select if only one browser
    local browser_choice
    if [ ${#available_browsers[@]} -eq 1 ]; then
        browser_choice="${available_browsers[0]}"
        echo "Using ${browser_choice} (only browser detected)"
    else
        echo -n "Choose browser [1-${#available_browsers[@]}]: "
        read -r choice
        
        if [ -z "$choice" ] || [ "$choice" -lt 1 ] || [ "$choice" -gt ${#available_browsers[@]} ]; then
            echo "âŒ Invalid choice"
            return 1
        fi
        
        browser_choice="${available_browsers[$((choice-1))]}"
    fi
    
    echo ""
    echo "â³ Testing authentication with ${browser_choice}..."
    
    # Test if we can extract cookies
    if ! timeout 10 yt-dlp --cookies-from-browser "$browser_choice" --simulate "https://www.youtube.com/" &>/dev/null; then
        echo "âŒ Failed to extract cookies from ${browser_choice}"
        echo ""
        echo "Make sure:"
        echo "  1. You're logged into YouTube in ${browser_choice}"
        echo "  2. ${browser_choice} is not running (close it and try again)"
        return 1
    fi
    
    # Save to config
    {
        echo ""
        echo "# Authentication (auto-configured)"
        echo "AUTH_METHOD=\"browser\""
        echo "BROWSER=\"$browser_choice\""
    } >> "$CONFIG_FILE"
    
    # Reload config
    load_config
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Authentication configured!"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Using: ${browser_choice} cookies"
    echo "Saved to: $CONFIG_FILE"
    echo ""
    
    return 0
}

# Get authentication arguments for yt-dlp
get_auth_args() {
    # Check if authentication is configured
    if [ -z "$BROWSER" ]; then
        # Not configured - run setup
        if ! setup_authentication; then
            return 1
        fi
    fi
    
    # Return the auth argument
    echo "--cookies-from-browser $BROWSER"
    return 0
}

# Generate cache key from search term
get_cache_key() {
    local search_term="$1"
    local search_type="$2"  # "video" or "playlist"
    echo "${search_type}_$(echo -n "$search_term" | md5)"
}

# Check if cache is valid (not expired)
is_cache_valid() {
    local cache_file="$1"
    
    if [ ! -f "$cache_file" ]; then
        return 1
    fi
    
    local current_time
    current_time=$(date +%s)
    local file_time
    file_time=$(stat -f %m "$cache_file" 2>/dev/null || stat -c %Y "$cache_file" 2>/dev/null)
    local age=$((current_time - file_time))
    
    if [ "$age" -lt "$CACHE_EXPIRY" ]; then
        return 0
    else
        return 1
    fi
}

# Cleanup function for temp files
cleanup() {
    local exit_code=$?
    if [ -n "$tmpfile" ] && [ -f "$tmpfile" ]; then
        rm -f "$tmpfile"
    fi
    exit "$exit_code"
}

trap cleanup EXIT INT TERM

# Check dependencies
check_dependencies() {
    local missing_deps=()
    local optional_deps=()
    
    # Required dependencies
    command -v yt-dlp &> /dev/null || missing_deps+=("yt-dlp")
    command -v mpv &> /dev/null || missing_deps+=("mpv")
    command -v fzf &> /dev/null || missing_deps+=("fzf")
    command -v jq &> /dev/null || missing_deps+=("jq")
    command -v curl &> /dev/null || missing_deps+=("curl")
    
    # Optional dependencies
    command -v chafa &> /dev/null || optional_deps+=("chafa")
    
    if [ ${#missing_deps[@]} -ne 0 ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Missing required dependencies"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Please install the following:"
        for dep in "${missing_deps[@]}"; do
            echo "  â€¢ $dep"
        done
        echo ""
        echo "Installation command (macOS):"
        echo "  brew install ${missing_deps[*]}"
        echo ""
        echo "Installation command (Linux/Debian):"
        echo "  sudo apt install ${missing_deps[*]}"
        echo ""
        return 1
    fi
    
    # Test if yt-dlp is working
    if ! timeout 10 yt-dlp --version &>/dev/null; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ yt-dlp is not working properly"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "Try updating yt-dlp:"
        if command -v brew &> /dev/null; then
            echo "  brew upgrade yt-dlp"
        elif command -v pip3 &> /dev/null; then
            echo "  pip3 install --upgrade yt-dlp"
        elif command -v pip &> /dev/null; then
            echo "  pip install --upgrade yt-dlp"
        else
            echo "  Visit: https://github.com/yt-dlp/yt-dlp#installation"
        fi
        echo ""
        return 1
    fi
    
    if [ ${#optional_deps[@]} -ne 0 ]; then
        echo "â„¹ï¸  Optional: Install 'chafa' for thumbnail previews"
        echo "   brew install chafa"
        echo ""
    fi
    
    return 0
}

# Show usage information
show_usage() {
    echo "Usage: yt [OPTIONS] <search term>"
    echo ""
    echo "Search Options:"
    echo "  -f, --first        Auto-play first search result"
    echo "  -a, --audio-only   Play audio only (no video)"
    echo "  -p, --playlist     Search for playlists instead of videos"
    echo "  --no-autoplay      Disable autoplay (autoplay is ON by default)"
    echo ""
    echo "Personal Account:"
    echo "  --me               Browse your YouTube account (interactive menu)"
    echo "  --home             View personalized recommendations"
    echo "  --subs             Browse latest videos from subscriptions"
    echo "  --playlists        Access your playlists"
    echo "  --watch-later      View watch later queue"
    echo "  --liked            Browse liked videos"
    echo ""
    echo "Other Options:"
    echo "  --clear-cache      Clear search and playlist cache"
    echo "  -h, --help         Show this help message"
    echo ""
    echo "Examples:"
    echo "  yt lofi beats                # Search, select, then autoplay related videos"
    echo "  yt -f lofi hip hop           # Auto-play first result, then autoplay"
    echo "  yt -a music                  # Audio-only with autoplay"
    echo "  yt -p lofi playlists         # Browse & autoplay playlists"
    echo "  yt --no-autoplay vim tutorial # Play once and exit (no autoplay)"
    echo "  yt <url>                     # Play video from URL"
    echo ""
    echo "  yt --me                      # Interactive menu for your account"
    echo "  yt --subs                    # Latest from subscriptions"
    echo "  yt --home -a                 # Recommendations in audio-only mode"
    echo ""
    echo "Autoplay:"
    echo "  Autoplay is ENABLED by default - videos/playlists continue automatically"
    echo "  After your selection plays, related content plays next (YouTube-style)"
    echo "  Press Ctrl+C during countdown to stop autoplay"
    echo ""
    echo "Authentication:"
    echo "  Personal features require browser cookies (Brave, Firefox, Chrome, etc.)"
    echo "  Setup runs automatically on first use - no passwords needed!"
    echo ""
    echo "Cache:"
    echo "  Search results are cached for $((CACHE_EXPIRY / 60)) minutes"
    echo "  Cache location: $SEARCH_CACHE_DIR"
    echo ""
    echo "Version: $VERSION"
    echo "Configuration file: $CONFIG_FILE"
}

# Clear cache
clear_cache() {
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ—‘ï¸  Clearing cache..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    local deleted=0
    
    if [ -d "$SEARCH_CACHE_DIR" ]; then
        local count
        count=$(find "$SEARCH_CACHE_DIR" -type f | wc -l | xargs)
        rm -rf "${SEARCH_CACHE_DIR:?}"/*
        deleted=$((deleted + count))
        echo "âœ“ Cleared search cache ($count files)"
    fi
    
    if [ -d "$PLAYLIST_CACHE_DIR" ]; then
        local count
        count=$(find "$PLAYLIST_CACHE_DIR" -type f | wc -l | xargs)
        rm -rf "${PLAYLIST_CACHE_DIR:?}"/*
        deleted=$((deleted + count))
        echo "âœ“ Cleared playlist cache ($count files)"
    fi
    
    if [ -d "$CACHE_DIR" ]; then
        local count
        count=$(find "$CACHE_DIR" -name "*.jpg" | wc -l | xargs)
        rm -rf "${CACHE_DIR:?}"/*.jpg
        deleted=$((deleted + count))
        echo "âœ“ Cleared thumbnail cache ($count files)"
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Cleared $deleted cached items"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
}

# Play video from URL
play_url() {
    local url="$1"
    local audio_only="$2"
    local format
    
    if [ "$audio_only" = "true" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸµ Playing audio from URL..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        format="bestaudio/best"
    else
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â–¶ Playing video from URL..."
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        format="bestvideo[height<=${MAX_QUALITY}]+bestaudio/best"
    fi
    echo ""
    
    if ! mpv "$url" \
        --ytdl-format="$format" \
        --volume="$VOLUME" \
        --audio-device=auto; then
        echo "âŒ Error playing video"
        return 1
    fi
    
    return 0
}

# Search YouTube for playlists
search_playlists_youtube() {
    local search_term="$1"
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“š Searching YouTube playlists for: $search_term"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Create temp file
    tmpfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # Check cache first
    local cache_key
    cache_key=$(get_cache_key "$search_term" "playlist")
    local cache_file="$SEARCH_CACHE_DIR/$cache_key.json"
    
    if is_cache_valid "$cache_file"; then
        echo "ğŸ“¦ Loading from cache..."
        cp "$cache_file" "$tmpfile"
        
        # Display cached results
        local count=0
        while IFS=$'\t' read -r title _ id _; do
            count=$((count + 1))
            echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$title" | cut -c1-60)..."
        done < "$tmpfile"
        echo ""
        return 0
    fi
    
    # URL-encode the search term
    local encoded_term
    encoded_term=$(echo "$search_term" | sed 's/ /+/g')
    
    # Create temp file for raw JSON
    local jsonfile
    jsonfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # Use YouTube search URL with playlist filter (sp=EgIQAw%253D%253D)
    # This filter specifically searches for playlists
    local error_output
    error_output=$(mktemp)
    
    # Run fetch with spinner
    (
        timeout "$TIMEOUT" yt-dlp "https://www.youtube.com/results?search_query=${encoded_term}&sp=EgIQAw%253D%253D" \
            --flat-playlist \
            --dump-json \
            --skip-download \
            --no-warnings \
            --quiet \
            --playlist-end "$NUM_RESULTS" \
            2>"$error_output" > "$jsonfile"
    ) &
    local fetch_pid=$!
    
    show_spinner "$fetch_pid" "Fetching playlists from YouTube..."
    wait "$fetch_pid"
    local fetch_result=$?
    
    if [ "$fetch_result" -ne 0 ]; then
        rm -f "$jsonfile"
        
        echo "âŒ Search failed or timed out"
        echo ""
        
        # Check if there's useful error info
        if [ -s "$error_output" ]; then
            echo "Error details:"
            head -3 "$error_output" | sed 's/^/  /'
            echo ""
        fi
        
        echo "Troubleshooting steps:"
        echo "  1. Update yt-dlp:"
        if command -v brew &> /dev/null; then
            echo "     brew upgrade yt-dlp"
        elif command -v pip3 &> /dev/null; then
            echo "     pip3 install --upgrade yt-dlp"
        elif command -v pip &> /dev/null; then
            echo "     pip install --upgrade yt-dlp"
        else
            echo "     Visit: https://github.com/yt-dlp/yt-dlp#installation"
        fi
        
        echo ""
        echo "  2. Check your internet connection"
        echo "  3. Try a different search term"
        
        rm -f "$error_output"
        return 1
    fi
    
    rm -f "$error_output"
    
    # Parse and display results
    local count=0
    while IFS= read -r line && [ "$count" -lt "$NUM_RESULTS" ]; do
        # Extract playlist info
        local playlist_title playlist_id thumbnail
        playlist_title=$(echo "$line" | jq -r '.title // "Unknown"')
        playlist_id=$(echo "$line" | jq -r '.id // ""')
        thumbnail=$(echo "$line" | jq -r '.thumbnails[0].url // ""')
        
        if [ -n "$playlist_id" ] && [ "$playlist_id" != "null" ]; then
            # Store: title, "PL" (placeholder for count), id, thumbnail
            echo "$playlist_title"$'\t'"PL"$'\t'"$playlist_id"$'\t'"$thumbnail" >> "$tmpfile"
            
            count=$((count + 1))
            echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$playlist_title" | cut -c1-60)..."
        fi
    done < "$jsonfile"
    
    rm -f "$jsonfile"
    echo ""
    
    # Check if we got any results
    if [ ! -s "$tmpfile" ] || [ "$count" -eq 0 ]; then
        echo "âŒ No playlists found!"
        return 1
    fi
    
    # Cache the results
    cp "$tmpfile" "$cache_file"
    
    return 0
}

# Search YouTube for videos
search_youtube() {
    local search_term="$1"
    local search_playlists="$2"
    
    # Use different search for playlists
    if [ "$search_playlists" = "true" ]; then
        search_playlists_youtube "$search_term"
        return $?
    fi
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ” Searching YouTube for: $search_term"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Create temp file
    tmpfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # Check cache first
    local cache_key
    cache_key=$(get_cache_key "$search_term" "video")
    local cache_file="$SEARCH_CACHE_DIR/$cache_key.json"
    
    if is_cache_valid "$cache_file"; then
        echo "ğŸ“¦ Loading from cache..."
        cp "$cache_file" "$tmpfile"
        
        # Display cached results
        local count=0
        while IFS=$'\t' read -r title _ _ _; do
            count=$((count + 1))
            echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$title" | cut -c1-60)..."
        done < "$tmpfile"
        echo ""
        return 0
    fi
    
    # Create temp file for raw JSON
    local jsonfile
    jsonfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # Fetch videos to temp file
    local error_output
    error_output=$(mktemp)
    
    # Run fetch with spinner
    (
        timeout "$TIMEOUT" yt-dlp "ytsearch${NUM_RESULTS}:$search_term" \
            --dump-json \
            --skip-download \
            --no-warnings \
            --quiet \
            > "$jsonfile" 2>"$error_output"
    ) &
    local fetch_pid=$!
    
    show_spinner "$fetch_pid" "Fetching videos from YouTube..."
    wait "$fetch_pid"
    local fetch_result=$?
    
    if [ "$fetch_result" -ne 0 ]; then
        rm -f "$jsonfile"
        
        echo "âŒ Search failed or timed out"
        echo ""
        
        # Check if there's useful error info
        if [ -s "$error_output" ]; then
            echo "Error details:"
            head -3 "$error_output" | sed 's/^/  /'
            echo ""
        fi
        
        echo "Troubleshooting steps:"
        echo "  1. Update yt-dlp:"
        if command -v brew &> /dev/null; then
            echo "     brew upgrade yt-dlp"
        elif command -v pip3 &> /dev/null; then
            echo "     pip3 install --upgrade yt-dlp"
        elif command -v pip &> /dev/null; then
            echo "     pip install --upgrade yt-dlp"
        else
            echo "     Visit: https://github.com/yt-dlp/yt-dlp#installation"
        fi
        
        echo ""
        echo "  2. Check your internet connection"
        echo "  3. Try a different search term"
        
        rm -f "$error_output"
        return 1
    fi
    
    rm -f "$error_output"
    
    # Parse and display results
    local count=0
    while IFS= read -r line && [ "$count" -lt "$NUM_RESULTS" ]; do
        # Parse video data
        video_data=$(echo "$line" | jq -r '"\(.title)\t\(.duration_string // "LIVE")\t\(.id)\t\(.thumbnail)"')
        echo "$video_data" >> "$tmpfile"
        
        count=$((count + 1))
        echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$line" | jq -r '.title' | cut -c1-60)..."
    done < "$jsonfile"
    
    rm -f "$jsonfile"
    echo ""
    
    # Check if we got any results
    if [ ! -s "$tmpfile" ] || [ "$count" -eq 0 ]; then
        echo "âŒ No results found!"
        return 1
    fi
    
    # Cache the results
    cp "$tmpfile" "$cache_file"
    
    return 0
}

# Download thumbnails
download_thumbnails() {
    local search_playlists="$1"
    mkdir -p "$CACHE_DIR" || { echo "âŒ Failed to create cache directory"; return 1; }
    
    while IFS=$'\t' read -r title duration id thumbnail; do
        if [ "$search_playlists" = "true" ]; then
            # Format playlist result line
            results="${results}$(printf "%-85s %s" "$title" "$id")"$'\n'
        else
            # Format video result line
            results="${results}$(printf "%-80s [%8s] %s" "$title" "$duration" "$id")"$'\n'
        fi
        
        # Download thumbnail in background for preview
        if [ -n "$thumbnail" ]; then
            curl -s "$thumbnail" -o "$CACHE_DIR/$id.jpg" 2>/dev/null &
        fi
    done < "$tmpfile"
    
    if [ -z "$results" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ No results found!"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        return 1
    fi
    
    # Count actual non-empty lines
    items_count=$(echo "$results" | grep -c '^.')
    if [ "$search_playlists" = "true" ]; then
        echo "âœ… Successfully fetched $items_count playlists!"
    else
        echo "âœ… Successfully fetched $items_count videos!"
    fi
    
    # Wait for thumbnails with spinner
    (sleep 2) &
    local sleep_pid=$!
    show_spinner "$sleep_pid" "Downloading thumbnails..."
    wait "$sleep_pid"
    
    echo "âœ… Ready!"
    sleep 0.5
    
    return 0
}

# Preview playlist contents (for fzf preview)
preview_playlist() {
    local playlist_id="$1"
    
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“š Playlist Contents"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    # Check cache first
    local cache_file="$PLAYLIST_CACHE_DIR/$playlist_id.json"
    
    if is_cache_valid "$cache_file"; then
        echo "ğŸ“¦ Cached playlist"
        echo ""
        
        # Read from cache
        local videos
        videos=$(cat "$cache_file")
        
        # Display first 20 videos
        local count=0
        while IFS= read -r line; do
            local video_title
            video_title=$(echo "$line" | jq -r '.title // "Unknown"')
            count=$((count + 1))
            printf "%2d. %s\n" "$count" "$video_title"
            [ "$count" -ge 20 ] && break
        done <<< "$videos"
        
        # Get total count
        local total_count
        total_count=$(echo "$videos" | wc -l | xargs)
        
        if [ "$total_count" -gt 20 ]; then
            echo ""
            echo "... and $((total_count - 20)) more videos"
        fi
        
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "Total: $total_count videos in playlist"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        return 0
    fi
    
    echo "â³ Loading videos..."
    echo ""
    
    # Fetch first 20 videos from playlist
    local videos
    videos=$(timeout 10 yt-dlp "https://youtube.com/playlist?list=$playlist_id" \
        --flat-playlist \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        --playlist-end 20 \
        2>/dev/null)
    
    if [ -z "$videos" ]; then
        echo "âŒ Could not load playlist contents"
        return 1
    fi
    
    # Display first 20 videos
    local count=0
    while IFS= read -r line; do
        local video_title
        video_title=$(echo "$line" | jq -r '.title // "Unknown"')
        count=$((count + 1))
        printf "%2d. %s\n" "$count" "$video_title"
    done <<< "$videos"
    
    # Get total count
    local total_count
    total_count=$(echo "$videos" | wc -l | xargs)
    
    # Check if there are more videos (but don't wait too long)
    local full_count
    full_count=$(timeout 5 yt-dlp "https://youtube.com/playlist?list=$playlist_id" \
        --flat-playlist \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        2>/dev/null | wc -l | xargs)
    
    if [ -n "$full_count" ] && [ "$full_count" -gt 20 ]; then
        echo ""
        echo "... and $((full_count - 20)) more videos"
        total_count=$full_count
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "Total: $total_count videos in playlist"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    # Cache the full result
    echo "$videos" > "$cache_file"
}

# Play entire playlist
play_playlist() {
    local playlist_id="$1"
    local playlist_title="$2"
    local audio_only="$3"
    local format
    local url
    
    url="https://youtube.com/playlist?list=$playlist_id"
    
    # Set format based on audio-only flag
    if [ "$audio_only" = "true" ]; then
        format="bestaudio/best"
    else
        format="bestvideo[height<=${MAX_QUALITY}]+bestaudio/best"
    fi
    
    clear
    if [ "$audio_only" = "true" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸµ PLAYING PLAYLIST (AUDIO ONLY)"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    else
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸ“š PLAYING PLAYLIST"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    fi
    echo ""
    echo "Playlist: $playlist_title"
    echo "URL:      $url"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "MPV Settings:"
    echo "  - Format: $format"
    echo "  - Volume: $VOLUME"
    echo "  - Audio Device: auto"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Starting playlist playback in 2 seconds..."
    sleep 2
    
    # Play playlist with mpv
    if ! mpv "$url" \
        --ytdl-format="$format" \
        --volume="$VOLUME" \
        --audio-device=auto; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Playback failed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        return 1
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Playlist finished"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    return 0
}

# Select video with fzf or return first result
select_video() {
    local search_term="$1"
    local auto_first="$2"
    local search_playlists="$3"
    local videos_count
    local selected
    
    # Count actual non-empty lines
    videos_count=$(echo "$results" | grep -c '^.')
    
    # If auto-first flag is set, return first result
    if [ "$auto_first" = "true" ]; then
        selected=$(echo "$results" | head -n 1)
        if [ -z "$selected" ]; then
            echo "âŒ No results found" >&2
            return 1
        fi
        echo "ğŸ¯ Auto-playing first result..." >&2
        echo "" >&2
        echo "$selected"
        return 0
    fi
    
    # Clear screen and show results (redirect to stderr to avoid capture)
    clear >&2
    if [ "$search_playlists" = "true" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
        echo "ğŸ“š YouTube Playlists: $search_term ($videos_count results)" >&2
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    else
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
        echo "ğŸ¥ YouTube Search: $search_term ($videos_count results)" >&2
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
    fi
    echo "" >&2
    
    # Different preview based on search mode
    if [ "$search_playlists" = "true" ]; then
        # For playlist mode, show playlist contents
        selected=$(echo "$results" | fzf \
            --height=90% \
            --layout=reverse \
            --border \
            --prompt="ğŸ“š " \
            --header="[j/k] navigate | [Ctrl-d/u] page | [Enter] play playlist | [q] quit" \
            --preview="$0 --preview-playlist \$(echo {} | awk '{print \$NF}')" \
            --preview-window=right:60%:wrap \
            --color='fg:#ffffff,bg:#000000,hl:#ff0000,fg+:#ffffff,bg+:#333333,hl+:#ff0000' \
            --pointer='â–¶' \
            --marker='âœ“' \
            --bind 'j:down,k:up' \
            --bind 'ctrl-d:half-page-down,ctrl-u:half-page-up' \
            --bind 'ctrl-f:page-down,ctrl-b:page-up' \
            --bind 'q:abort')
    else
        # For videos, show thumbnail
        selected=$(echo "$results" | fzf \
            --height=90% \
            --layout=reverse \
            --border \
            --prompt="â–¶ " \
            --header="[j/k] navigate | [Ctrl-d/u] page | [Enter] play | [q] quit" \
            --preview="video_id=\$(echo {} | awk '{print \$NF}'); if [ -f \"$CACHE_DIR/\$video_id.jpg\" ]; then chafa --format=kitty --size=60x30 \"$CACHE_DIR/\$video_id.jpg\" 2>/dev/null; else echo 'â³ Downloading thumbnail...'; fi" \
            --preview-window=right:40%:wrap \
            --color='fg:#ffffff,bg:#000000,hl:#ff0000,fg+:#ffffff,bg+:#333333,hl+:#ff0000' \
            --pointer='â–¶' \
            --marker='âœ“' \
            --bind 'j:down,k:up' \
            --bind 'ctrl-d:half-page-down,ctrl-u:half-page-up' \
            --bind 'ctrl-f:page-down,ctrl-b:page-up' \
            --bind 'q:abort')
    fi
    
    if [ -z "$selected" ]; then
        echo "" >&2
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
        echo "âŒ Cancelled" >&2
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”" >&2
        return 1
    fi
    
    echo "$selected"
    return 0
}

# Get related videos for a given video ID
get_related_videos() {
    local video_id="$1"
    local num_results="${2:-5}"
    
    echo "â³ Finding related videos..." >&2
    
    # Use yt-dlp to get the video page and extract related video IDs
    # YouTube's related videos are in the page data
    local related_data
    related_data=$(timeout "$TIMEOUT" yt-dlp "https://youtube.com/watch?v=$video_id" \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        --playlist-items 1 \
        2>/dev/null)
    
    if [ -z "$related_data" ]; then
        echo "âŒ Could not fetch related videos" >&2
        return 1
    fi
    
    # Try to extract channel info to get more videos from same channel
    local channel_id
    channel_id=$(echo "$related_data" | jq -r '.channel_id // empty')
    
    if [ -n "$channel_id" ]; then
        # Get latest videos from the same channel
        timeout "$TIMEOUT" yt-dlp "https://youtube.com/channel/$channel_id/videos" \
            --flat-playlist \
            --dump-json \
            --skip-download \
            --no-warnings \
            --quiet \
            --playlist-end "$num_results" \
            2>/dev/null | while IFS= read -r line; do
                local vid_id vid_title vid_duration vid_thumbnail
                vid_id=$(echo "$line" | jq -r '.id // empty')
                vid_title=$(echo "$line" | jq -r '.title // "Unknown"')
                vid_duration=$(echo "$line" | jq -r '.duration_string // "LIVE"')
                vid_thumbnail=$(echo "$line" | jq -r '.thumbnail // empty')
                
                # Skip if it's the same video
                if [ "$vid_id" != "$video_id" ] && [ -n "$vid_id" ]; then
                    echo "$vid_title"$'\t'"$vid_duration"$'\t'"$vid_id"$'\t'"$vid_thumbnail"
                fi
            done
        return 0
    fi
    
    return 1
}

# Get related playlists
get_related_playlists() {
    local playlist_id="$1"
    local num_results="${2:-3}"
    
    echo "â³ Finding related playlists..." >&2
    
    # Get playlist info to extract channel or search similar content
    local playlist_data
    playlist_data=$(timeout "$TIMEOUT" yt-dlp "https://youtube.com/playlist?list=$playlist_id" \
        --dump-json \
        --flat-playlist \
        --skip-download \
        --no-warnings \
        --quiet \
        --playlist-items 1 \
        2>/dev/null | head -n 1)
    
    if [ -z "$playlist_data" ]; then
        echo "âŒ Could not fetch playlist data" >&2
        return 1
    fi
    
    # Extract channel ID
    local channel_id
    channel_id=$(echo "$playlist_data" | jq -r '.channel_id // empty')
    
    if [ -n "$channel_id" ]; then
        # Get playlists from the same channel
        timeout "$TIMEOUT" yt-dlp "https://youtube.com/channel/$channel_id/playlists" \
            --flat-playlist \
            --dump-json \
            --skip-download \
            --no-warnings \
            --quiet \
            --playlist-end "$num_results" \
            2>/dev/null | while IFS= read -r line; do
                local pl_id pl_title pl_thumbnail
                pl_id=$(echo "$line" | jq -r '.id // empty')
                pl_title=$(echo "$line" | jq -r '.title // "Unknown"')
                pl_thumbnail=$(echo "$line" | jq -r '.thumbnails[0].url // empty')
                
                # Skip if it's the same playlist
                if [ "$pl_id" != "$playlist_id" ] && [ -n "$pl_id" ]; then
                    echo "$pl_title"$'\t'"PL"$'\t'"$pl_id"$'\t'"$pl_thumbnail"
                fi
            done
        return 0
    fi
    
    return 1
}

# Fetch home/recommendations feed
fetch_home_feed() {
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ  Fetching personalized recommendations..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    local auth_args
    auth_args=$(get_auth_args) || return 1
    
    # Create temp file
    tmpfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    echo "â³ Loading your recommendations..."
    
    # Fetch recommended videos from YouTube home
    local jsonfile
    jsonfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # shellcheck disable=SC2086
    if ! timeout "$TIMEOUT" yt-dlp $auth_args "https://www.youtube.com/feed/recommended" \
        --flat-playlist \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        --playlist-end "$NUM_RESULTS" \
        2>/dev/null > "$jsonfile"; then
        rm -f "$jsonfile"
        echo "âŒ Failed to fetch recommendations"
        echo ""
        echo "Make sure you're logged into YouTube in your browser."
        return 1
    fi
    
    # Parse and display results
    local count=0
    while IFS= read -r line && [ "$count" -lt "$NUM_RESULTS" ]; do
        local video_data
        video_data=$(echo "$line" | jq -r '"\(.title)\t\(.duration_string // "LIVE")\t\(.id)\t\(.thumbnail)"')
        
        if [ -n "$video_data" ]; then
            echo "$video_data" >> "$tmpfile"
            count=$((count + 1))
            echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$line" | jq -r '.title' | cut -c1-60)..."
        fi
    done < "$jsonfile"
    
    rm -f "$jsonfile"
    echo ""
    
    if [ ! -s "$tmpfile" ] || [ "$count" -eq 0 ]; then
        echo "âŒ No recommendations found!"
        return 1
    fi
    
    echo "âœ… Successfully fetched $count recommendations!"
    echo ""
    
    return 0
}

# Fetch subscriptions feed
fetch_subscriptions_feed() {
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“º Fetching subscriptions feed..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    local auth_args
    auth_args=$(get_auth_args) || return 1
    
    # Create temp file
    tmpfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    echo "â³ Loading latest videos from your subscriptions..."
    
    # Fetch subscription feed
    local jsonfile
    jsonfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # shellcheck disable=SC2086
    if ! timeout "$TIMEOUT" yt-dlp $auth_args "https://www.youtube.com/feed/subscriptions" \
        --flat-playlist \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        --playlist-end "$NUM_RESULTS" \
        2>/dev/null > "$jsonfile"; then
        rm -f "$jsonfile"
        echo "âŒ Failed to fetch subscriptions"
        echo ""
        echo "Make sure you're logged into YouTube in your browser."
        return 1
    fi
    
    # Parse and display results
    local count=0
    while IFS= read -r line && [ "$count" -lt "$NUM_RESULTS" ]; do
        local video_data
        video_data=$(echo "$line" | jq -r '"\(.title)\t\(.duration_string // "LIVE")\t\(.id)\t\(.thumbnail)"')
        
        if [ -n "$video_data" ]; then
            echo "$video_data" >> "$tmpfile"
            count=$((count + 1))
            echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$line" | jq -r '.title' | cut -c1-60)..."
        fi
    done < "$jsonfile"
    
    rm -f "$jsonfile"
    echo ""
    
    if [ ! -s "$tmpfile" ] || [ "$count" -eq 0 ]; then
        echo "âŒ No subscription videos found!"
        return 1
    fi
    
    echo "âœ… Successfully fetched $count videos!"
    echo ""
    
    return 0
}

# Fetch user playlists
fetch_user_playlists() {
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ“š Fetching your playlists..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    local auth_args
    auth_args=$(get_auth_args) || return 1
    
    # Create temp file
    tmpfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    echo "â³ Loading your playlists..."
    
    # Fetch user's playlists
    local jsonfile
    jsonfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # shellcheck disable=SC2086
    if ! timeout "$TIMEOUT" yt-dlp $auth_args "https://www.youtube.com/feed/library" \
        --flat-playlist \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        --playlist-end "$NUM_RESULTS" \
        2>/dev/null > "$jsonfile"; then
        rm -f "$jsonfile"
        echo "âŒ Failed to fetch playlists"
        echo ""
        echo "Make sure you're logged into YouTube in your browser."
        return 1
    fi
    
    # Parse and display results
    local count=0
    while IFS= read -r line && [ "$count" -lt "$NUM_RESULTS" ]; do
        local playlist_title playlist_id thumbnail
        playlist_title=$(echo "$line" | jq -r '.title // "Unknown"')
        playlist_id=$(echo "$line" | jq -r '.id // ""')
        thumbnail=$(echo "$line" | jq -r '.thumbnails[0].url // ""')
        
        if [ -n "$playlist_id" ] && [ "$playlist_id" != "null" ]; then
            echo "$playlist_title"$'\t'"PL"$'\t'"$playlist_id"$'\t'"$thumbnail" >> "$tmpfile"
            count=$((count + 1))
            echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$playlist_title" | cut -c1-60)..."
        fi
    done < "$jsonfile"
    
    rm -f "$jsonfile"
    echo ""
    
    if [ ! -s "$tmpfile" ] || [ "$count" -eq 0 ]; then
        echo "âŒ No playlists found!"
        return 1
    fi
    
    echo "âœ… Successfully fetched $count playlists!"
    echo ""
    
    return 0
}

# Fetch watch later playlist
fetch_watch_later() {
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ• Fetching watch later..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    local auth_args
    auth_args=$(get_auth_args) || return 1
    
    # Create temp file
    tmpfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    echo "â³ Loading your watch later videos..."
    
    # Fetch watch later playlist (WL)
    local jsonfile
    jsonfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # shellcheck disable=SC2086
    if ! timeout "$TIMEOUT" yt-dlp $auth_args "https://www.youtube.com/playlist?list=WL" \
        --flat-playlist \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        --playlist-end "$NUM_RESULTS" \
        2>/dev/null > "$jsonfile"; then
        rm -f "$jsonfile"
        echo "âŒ Failed to fetch watch later"
        echo ""
        echo "Make sure you're logged into YouTube in your browser."
        return 1
    fi
    
    # Parse and display results
    local count=0
    while IFS= read -r line && [ "$count" -lt "$NUM_RESULTS" ]; do
        local video_data
        video_data=$(echo "$line" | jq -r '"\(.title)\t\(.duration_string // "LIVE")\t\(.id)\t\(.thumbnail)"')
        
        if [ -n "$video_data" ]; then
            echo "$video_data" >> "$tmpfile"
            count=$((count + 1))
            echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$line" | jq -r '.title' | cut -c1-60)..."
        fi
    done < "$jsonfile"
    
    rm -f "$jsonfile"
    echo ""
    
    if [ ! -s "$tmpfile" ] || [ "$count" -eq 0 ]; then
        echo "âŒ Watch later is empty!"
        return 1
    fi
    
    echo "âœ… Successfully fetched $count videos!"
    echo ""
    
    return 0
}

# Fetch liked videos
fetch_liked_videos() {
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ‘ Fetching liked videos..."
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    
    local auth_args
    auth_args=$(get_auth_args) || return 1
    
    # Create temp file
    tmpfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    echo "â³ Loading your liked videos..."
    
    # Fetch liked videos playlist (LL)
    local jsonfile
    jsonfile=$(mktemp) || { echo "âŒ Failed to create temp file"; return 1; }
    
    # shellcheck disable=SC2086
    if ! timeout "$TIMEOUT" yt-dlp $auth_args "https://www.youtube.com/playlist?list=LL" \
        --flat-playlist \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        --playlist-end "$NUM_RESULTS" \
        2>/dev/null > "$jsonfile"; then
        rm -f "$jsonfile"
        echo "âŒ Failed to fetch liked videos"
        echo ""
        echo "Make sure you're logged into YouTube in your browser."
        return 1
    fi
    
    # Parse and display results
    local count=0
    while IFS= read -r line && [ "$count" -lt "$NUM_RESULTS" ]; do
        local video_data
        video_data=$(echo "$line" | jq -r '"\(.title)\t\(.duration_string // "LIVE")\t\(.id)\t\(.thumbnail)"')
        
        if [ -n "$video_data" ]; then
            echo "$video_data" >> "$tmpfile"
            count=$((count + 1))
            echo "  âœ“ Found ($count/$NUM_RESULTS): $(echo "$line" | jq -r '.title' | cut -c1-60)..."
        fi
    done < "$jsonfile"
    
    rm -f "$jsonfile"
    echo ""
    
    if [ ! -s "$tmpfile" ] || [ "$count" -eq 0 ]; then
        echo "âŒ No liked videos found!"
        return 1
    fi
    
    echo "âœ… Successfully fetched $count videos!"
    echo ""
    
    return 0
}

# Fetch next videos from personal feed for autoplay
fetch_next_from_feed() {
    local feed_type="$1"  # home, subs, watch-later, liked
    local offset="${2:-0}"  # Skip first N videos
    local count="${3:-5}"  # How many to fetch
    
    local auth_args
    auth_args=$(get_auth_args) || return 1
    
    local feed_url
    case "$feed_type" in
        home)
            feed_url="https://www.youtube.com/feed/recommended"
            ;;
        subs)
            feed_url="https://www.youtube.com/feed/subscriptions"
            ;;
        watch-later)
            feed_url="https://www.youtube.com/playlist?list=WL"
            ;;
        liked)
            feed_url="https://www.youtube.com/playlist?list=LL"
            ;;
        *)
            return 1
            ;;
    esac
    
    # Fetch videos with offset
    local start=$((offset + 1))
    local end=$((offset + count))
    
    # shellcheck disable=SC2086
    timeout "$TIMEOUT" yt-dlp $auth_args "$feed_url" \
        --flat-playlist \
        --dump-json \
        --skip-download \
        --no-warnings \
        --quiet \
        --playlist-start "$start" \
        --playlist-end "$end" \
        2>/dev/null | while IFS= read -r line; do
            echo "$line" | jq -r '"\(.title)\t\(.duration_string // "LIVE")\t\(.id)\t\(.thumbnail)"'
        done
}

# Show account menu and handle selection
show_account_menu() {
    clear
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ  YouTube Account"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "What would you like to browse?"
    echo ""
    echo "  1. ğŸ  Home / Recommendations"
    echo "  2. ğŸ“º Subscriptions Feed"
    echo "  3. ğŸ“š Your Playlists"
    echo "  4. ğŸ• Watch Later"
    echo "  5. ğŸ‘ Liked Videos"
    echo ""
    echo "  q. Quit"
    echo ""
    echo -n "Choose [1-5, q]: "
    
    read -r choice
    echo ""
    
    case "$choice" in
        1)
            return 1  # home
            ;;
        2)
            return 2  # subs
            ;;
        3)
            return 3  # playlists
            ;;
        4)
            return 4  # watch later
            ;;
        5)
            return 5  # liked
            ;;
        q|Q)
            echo "Goodbye!"
            exit 0
            ;;
        *)
            echo "âŒ Invalid choice"
            sleep 1
            show_account_menu
            return $?
            ;;
    esac
}

# Countdown with ability to cancel
countdown_autoplay() {
    local seconds="$1"
    local next_title="$2"
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸ”„ AUTOPLAY"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Next: $next_title"
    echo ""
    
    for ((i=seconds; i>0; i--)); do
        echo -ne "\rStarting in $i seconds... [Press Ctrl+C to stop autoplay] "
        sleep 1
    done
    echo ""
    
    return 0
}

# Play selected video
play_video() {
    local selected="$1"
    local audio_only="$2"
    local video_id title url format
    
    video_id=$(echo "$selected" | awk '{print $NF}')
    title=$(echo "$selected" | sed 's/\[.*\].*$//' | xargs)
    url="https://youtube.com/watch?v=$video_id"
    
    # Set format based on audio-only flag
    if [ "$audio_only" = "true" ]; then
        format="bestaudio/best"
    else
        format="bestvideo[height<=${MAX_QUALITY}]+bestaudio/best"
    fi
    
    # Show thumbnail before playing
    clear
    if command -v chafa &> /dev/null && [ -f "$CACHE_DIR/$video_id.jpg" ]; then
        if [ "$audio_only" = "true" ]; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "ğŸµ AUDIO PREVIEW"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        else
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "â–¶ VIDEO PREVIEW"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        fi
        echo ""
        chafa --format=kitty --size=60x30 "$CACHE_DIR/$video_id.jpg" 2>/dev/null
        echo ""
    fi
    
    if [ "$audio_only" = "true" ]; then
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "ğŸµ PLAYING AUDIO"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    else
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "â–¶ PLAYING"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    fi
    echo ""
    echo "Title:    $title"
    echo "Video ID: $video_id"
    echo "URL:      $url"
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "MPV Settings:"
    echo "  - Format: $format"
    echo "  - Volume: $VOLUME"
    echo "  - Audio Device: auto"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo ""
    echo "Starting playback in 2 seconds..."
    sleep 2
    
    # Play with explicit settings
    if ! mpv "$url" \
        --ytdl-format="$format" \
        --volume="$VOLUME" \
        --audio-device=auto; then
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "âŒ Playback failed"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        return 1
    fi
    
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "âœ… Playback finished"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    
    return 0
}

# Main function
main() {
    # Load configuration
    load_config
    
    # Handle internal preview mode (called by fzf)
    if [ "$1" = "--preview-playlist" ]; then
        preview_playlist "$2"
        exit 0
    fi
    
    # Parse flags
    local auto_first=false
    local audio_only=false
    local search_playlists=false
    local autoplay=true  # Autoplay is now DEFAULT
    local search_term=""
    local personal_mode=""  # me, home, subs, playlists, watch-later, liked
    
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -f|--first)
                auto_first=true
                shift
                ;;
            -a|--audio-only)
                audio_only=true
                shift
                ;;
            -p|--playlist)
                search_playlists=true
                shift
                ;;
            --no-autoplay)
                autoplay=false
                shift
                ;;
            --me)
                personal_mode="me"
                shift
                ;;
            --home)
                personal_mode="home"
                shift
                ;;
            --subs)
                personal_mode="subs"
                shift
                ;;
            --playlists)
                personal_mode="playlists"
                shift
                ;;
            --watch-later)
                personal_mode="watch-later"
                shift
                ;;
            --liked)
                personal_mode="liked"
                shift
                ;;
            --clear-cache)
                clear_cache
                exit 0
                ;;
            -h|--help)
                show_usage
                exit 0
                ;;
            -*)
                echo "Unknown option: $1"
                show_usage
                exit 1
                ;;
            *)
                search_term="$search_term $1"
                shift
                ;;
        esac
    done
    
    # Trim leading/trailing whitespace
    search_term=$(echo "$search_term" | xargs)
    
    # Show usage if no search term (before checking dependencies)
    if [ -z "$search_term" ] && [ -z "$personal_mode" ]; then
        show_usage
        exit 1
    fi
    
    # Check dependencies (always run before usage to give helpful error messages)
    if ! check_dependencies; then
        exit 1
    fi
    
    # Handle personal mode
    if [ -n "$personal_mode" ]; then
        # If --me, show menu and get choice
        if [ "$personal_mode" = "me" ]; then
            show_account_menu
            local menu_choice=$?
            
            case $menu_choice in
                1) personal_mode="home" ;;
                2) personal_mode="subs" ;;
                3) personal_mode="playlists" ;;
                4) personal_mode="watch-later" ;;
                5) personal_mode="liked" ;;
                *) exit 1 ;;
            esac
        fi
        
        # Fetch the appropriate content
        case "$personal_mode" in
            home)
                if ! fetch_home_feed; then
                    exit 1
                fi
                search_term="Home"
                ;;
            subs)
                if ! fetch_subscriptions_feed; then
                    exit 1
                fi
                search_term="Subscriptions"
                ;;
            playlists)
                if ! fetch_user_playlists; then
                    exit 1
                fi
                search_playlists=true
                search_term="Your Playlists"
                ;;
            watch-later)
                if ! fetch_watch_later; then
                    exit 1
                fi
                search_term="Watch Later"
                ;;
            liked)
                if ! fetch_liked_videos; then
                    exit 1
                fi
                search_term="Liked Videos"
                ;;
        esac
        
        # Download thumbnails and format results
        if ! download_thumbnails "$search_playlists"; then
            exit 1
        fi
        
        # Select and play
        local selected
        if ! selected=$(select_video "$search_term" "$auto_first" "$search_playlists"); then
            exit 0
        fi
        
        # Handle playlist or video playback
        if [ "$search_playlists" = "true" ]; then
            local playlist_id playlist_title
            playlist_id=$(echo "$selected" | awk '{print $NF}')
            playlist_title=$(echo "$selected" | awk -F'\t' '{print $1}' | sed 's/^[[:space:]]*//' | xargs)
            
            if ! play_playlist "$playlist_id" "$playlist_title" "$audio_only"; then
                exit 1
            fi
            
            # Autoplay for playlists (same as regular playlist flow)
            if [ "$autoplay" = "true" ]; then
                while true; do
                    echo ""
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "âœ… Playlist finished"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    
                    local related_playlists
                    related_playlists=$(get_related_playlists "$playlist_id" 1)
                    
                    if [ -z "$related_playlists" ]; then
                        echo "âŒ No more related playlists found"
                        break
                    fi
                    
                    local next_playlist
                    next_playlist=$(echo "$related_playlists" | head -n 1)
                    
                    if [ -z "$next_playlist" ]; then
                        echo "âŒ No more related playlists found"
                        break
                    fi
                    
                    local next_pl_title next_pl_id
                    next_pl_title=$(echo "$next_playlist" | cut -f1)
                    next_pl_id=$(echo "$next_playlist" | cut -f3)
                    
                    if ! countdown_autoplay 5 "$next_pl_title"; then
                        break
                    fi
                    
                    playlist_id="$next_pl_id"
                    
                    if ! play_playlist "$next_pl_id" "$next_pl_title" "$audio_only"; then
                        echo "âŒ Failed to play next playlist"
                        break
                    fi
                done
            fi
        else
            # Play video
            if ! play_video "$selected" "$audio_only"; then
                exit 1
            fi
            
            # Autoplay for videos - use personalized feed for personal content
            if [ "$autoplay" = "true" ]; then
                local current_video_id
                current_video_id=$(echo "$selected" | awk '{print $NF}')
                local video_index=1  # Track position in feed
                
                while true; do
                    echo ""
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    echo "âœ… Video finished"
                    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                    
                    local next_video
                    
                    # For personal feeds, fetch next from the same feed
                    if [ "$personal_mode" = "home" ] || [ "$personal_mode" = "subs" ] || \
                       [ "$personal_mode" = "watch-later" ] || [ "$personal_mode" = "liked" ]; then
                        echo "â³ Loading next from your $search_term..."
                        next_video=$(fetch_next_from_feed "$personal_mode" "$video_index" 1)
                        video_index=$((video_index + 1))
                    else
                        # For regular searches, use related videos
                        local related_videos
                        related_videos=$(get_related_videos "$current_video_id" 5)
                        next_video=$(echo "$related_videos" | head -n 1)
                    fi
                    
                    if [ -z "$next_video" ]; then
                        echo "âŒ No more videos found"
                        break
                    fi
                    
                    local next_title next_duration next_id next_thumbnail
                    IFS=$'\t' read -r next_title next_duration next_id next_thumbnail <<< "$next_video"
                    local next_selected
                    next_selected=$(printf "%-80s [%8s] %s" "$next_title" "$next_duration" "$next_id")
                    
                    if [ -n "$next_thumbnail" ]; then
                        curl -s "$next_thumbnail" -o "$CACHE_DIR/$next_id.jpg" 2>/dev/null &
                    fi
                    
                    if ! countdown_autoplay 3 "$next_title"; then
                        break
                    fi
                    
                    current_video_id="$next_id"
                    
                    if ! play_video "$next_selected" "$audio_only"; then
                        echo "âŒ Failed to play next video"
                        break
                    fi
                done
            fi
        fi
        
        exit 0
    fi
    
    # Check if input is a URL
    if [[ "$search_term" =~ ^https?:// ]]; then
        if ! play_url "$search_term" "$audio_only"; then
            exit 1
        fi
        exit 0
    fi
    
    # Search YouTube
    if ! search_youtube "$search_term" "$search_playlists"; then
        exit 1
    fi
    
    # Download thumbnails and format results
    if ! download_thumbnails "$search_playlists"; then
        exit 1
    fi
    
    # Select video or playlist
    local selected
    if ! selected=$(select_video "$search_term" "$auto_first" "$search_playlists"); then
        exit 0
    fi
    
    # If playlist mode, play the selected playlist
    if [ "$search_playlists" = "true" ]; then
        local playlist_id playlist_title
        playlist_id=$(echo "$selected" | awk '{print $NF}')
        playlist_title=$(echo "$selected" | awk -F'\t' '{print $1}' | sed 's/^[[:space:]]*//' | xargs)
        
        if ! play_playlist "$playlist_id" "$playlist_title" "$audio_only"; then
            exit 1
        fi
        
        # If autoplay enabled, continue with related playlists
        if [ "$autoplay" = "true" ]; then
            while true; do
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "âœ… Playlist finished"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                
                # Get related playlists
                local related_playlists
                related_playlists=$(get_related_playlists "$playlist_id" 1)
                
                if [ -z "$related_playlists" ]; then
                    echo "âŒ No more related playlists found"
                    break
                fi
                
                # Get first related playlist
                local next_playlist
                next_playlist=$(echo "$related_playlists" | head -n 1)
                
                if [ -z "$next_playlist" ]; then
                    echo "âŒ No more related playlists found"
                    break
                fi
                
                # Extract playlist info
                local next_pl_title next_pl_id
                next_pl_title=$(echo "$next_playlist" | cut -f1)
                next_pl_id=$(echo "$next_playlist" | cut -f3)
                
                # Countdown before playing next
                if ! countdown_autoplay 5 "$next_pl_title"; then
                    break
                fi
                
                # Update current playlist ID for next iteration
                playlist_id="$next_pl_id"
                
                # Play next playlist
                if ! play_playlist "$next_pl_id" "$next_pl_title" "$audio_only"; then
                    echo "âŒ Failed to play next playlist"
                    break
                fi
            done
        fi
    else
        # Play single video
        if ! play_video "$selected" "$audio_only"; then
            exit 1
        fi
        
        # If autoplay enabled, continue with related videos
        if [ "$autoplay" = "true" ]; then
            local current_video_id
            current_video_id=$(echo "$selected" | awk '{print $NF}')
            
            while true; do
                echo ""
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                echo "âœ… Video finished"
                echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
                
                # Get related videos
                local related_videos
                related_videos=$(get_related_videos "$current_video_id" 5)
                
                if [ -z "$related_videos" ]; then
                    echo "âŒ No more related videos found"
                    break
                fi
                
                # Get first related video
                local next_video
                next_video=$(echo "$related_videos" | head -n 1)
                
                if [ -z "$next_video" ]; then
                    echo "âŒ No more related videos found"
                    break
                fi
                
                # Format as selected video
                local next_title next_duration next_id next_thumbnail
                IFS=$'\t' read -r next_title next_duration next_id next_thumbnail <<< "$next_video"
                local next_selected
                next_selected=$(printf "%-80s [%8s] %s" "$next_title" "$next_duration" "$next_id")
                
                # Download thumbnail for next video
                if [ -n "$next_thumbnail" ]; then
                    curl -s "$next_thumbnail" -o "$CACHE_DIR/$next_id.jpg" 2>/dev/null &
                fi
                
                # Countdown before playing next
                if ! countdown_autoplay 3 "$next_title"; then
                    break
                fi
                
                # Update current video ID for next iteration
                current_video_id="$next_id"
                
                # Play next video
                if ! play_video "$next_selected" "$audio_only"; then
                    echo "âŒ Failed to play next video"
                    break
                fi
            done
        fi
    fi
    
    exit 0
}

# Run main function
main "$@"
